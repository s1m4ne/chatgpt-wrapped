# Implementation Plan

## Tasks

- [x] 1. プロジェクト基盤セットアップ
- [x] 1.1 Vite + React + TypeScriptプロジェクトを初期化し、基本的な開発環境を構築する
  - Vite でReact + TypeScriptテンプレートを使用してプロジェクトを作成
  - Tailwind CSSをインストールしダークモード対応の設定を行う
  - ESLint、Prettierを設定してコード品質を維持
  - 環境変数（VITE_GEMINI_API_KEY）の読み込み設定を行う
  - _Requirements: 13.2_

- [x] 1.2 (P) 型定義とデータモデルを作成する
  - 会話データ（Conversation, Message）の型を定義
  - 分析結果（BasicStats, ActivityPattern等）の型を定義
  - APIリクエスト/レスポンスの型を定義
  - エラー型（ParseError, ApiError）を定義
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 1.3 (P) アプリケーション状態管理の基盤を構築する
  - React ContextとuseReducerで状態管理を実装
  - AnalysisState（status, progress, results）を管理するコンテキストを作成
  - 分析進行状況の更新ロジックを実装
  - _Requirements: 14.1, 14.2_

- [x] 2. データ入力機能の実装
- [x] 2.1 ファイルアップロードコンポーネントを作成する
  - ドラッグ&ドロップでJSONファイルを受け付けるUIを実装
  - ファイル選択ダイアログからのアップロードも対応
  - ドラッグ中のビジュアルフィードバックを追加
  - ファイルサイズ制限（100MB）のバリデーションを実装
  - _Requirements: 1.1, 1.2_

- [x] 2.2 conversations.jsonパーサーを実装する
  - JSONファイルの読み込みと基本的なバリデーション
  - mapping のtree構造を深さ優先探索でフラット化
  - メッセージを時系列順にソート
  - multimodal_text からテキスト部分のみを抽出
  - 無効なJSONやフォーマットエラーの検出と適切なエラーメッセージ表示
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 3. APIキー管理機能の実装
- [x] 3.1 APIキー入力フォームを作成する
  - Gemini APIキー入力用のフォームUIを実装
  - ローカルストレージへの保存オプション（チェックボックス）を追加
  - 保存済みAPIキーの自動読み込み機能
  - APIキー削除機能を実装
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 3.2 APIキーの検証機能を実装する
  - 入力されたAPIキーでGemini APIにテストリクエストを送信
  - 無効なAPIキーの場合は認証エラーを表示
  - 検証中のローディング状態を表示
  - _Requirements: 2.3_

- [x] 4. 基本統計機能の実装
- [x] 4.1 統計計算エンジンを実装する
  - 総会話数、総メッセージ数の集計
  - トークン数の推定（文字数ベースで概算）
  - 利用日数の計算
  - 最長連続利用日数（ストリーク）の算出
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4.2 (P) 活動パターン分析を実装する
  - 曜日×時間帯（7×24）のヒートマップデータを生成
  - 月別メッセージ数の集計
  - 曜日別利用傾向の集計
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 4.3 基本統計表示カードを作成する
  - 総会話数、メッセージ数、トークン数、利用日数、ストリークを表示するカード
  - Spotify Wrapped風のアニメーション演出を追加
  - ダークモードベースのスタイリング
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 13.1, 13.2, 13.3_

- [x] 4.4 活動パターン可視化コンポーネントを作成する
  - 時間帯別ヒートマップをRechartsまたはカスタムSVGで描画
  - 月別メッセージ数の棒グラフを描画
  - 曜日別利用傾向のグラフを描画
  - _Requirements: 4.1, 4.2, 4.3, 13.1_

- [x] 5. LLM分析基盤の実装
- [x] 5.1 Gemini APIクライアントを実装する
  - @google/generative-ai SDKを使用してAPIクライアントを作成
  - gemini-2.0-flashモデルでのテキスト生成機能
  - responseSchemaを使用したJSON構造化出力
  - レート制限対応（指数バックオフでリトライ）
  - エラーハンドリング（認証エラー、ネットワークエラー、レート制限）
  - _Requirements: 5.1, 6.1, 7.1, 9.1, 10.1, 11.1, 12.1, 14.3_

- [x] 5.2 分析オーケストレーターを実装する
  - 7種類のLLM分析を順次実行する制御ロジック
  - 各分析ステップの進行状況を更新
  - 分析中断（abort）機能
  - エラー発生時のリトライオプション
  - _Requirements: 14.1, 14.2, 14.3_

- [x] 6. LLM分析機能の実装（テキスト分析）
- [x] 6.1 (P) 単語・フレーズ分析を実装する
  - ユーザーメッセージから頻出単語TOP10を抽出するプロンプト設計
  - 口癖・頻出フレーズの抽出
  - TF-IDFベースの重要単語抽出
  - 結果を表示するカードコンポーネント
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 6.2 (P) トピック分類を実装する
  - 会話をトピック別に分類するプロンプト設計
  - トピック別の会話割合を算出
  - 各トピックに適切な絵文字を付与
  - 円グラフまたは棒グラフで可視化するカード
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 6.3 (P) テーマ変遷分析を実装する
  - 月ごとの主要テーマを抽出するプロンプト設計
  - 新しく登場したトピックを検出
  - タイムライングラフで変遷を可視化するカード
  - _Requirements: 7.1, 7.2, 7.3_

- [x] 7. LLM分析機能の実装（高度な分析）
- [x] 7.1 代表セッション選出を実装する
  - 会話の深度、技術密度、感情変動などを評価するプロンプト設計
  - ベスト5セッションを選出
  - 各セッションに印象的なタイトルと選出理由を生成
  - 結果を表示するカードコンポーネント
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 7.2 (P) 文章特徴・感情分析を実装する
  - 文章の特徴（技術的、カジュアル等）を分析するプロンプト設計
  - 感情傾向（好奇心、懸念等）の分析
  - 質問パターンの特徴分析
  - 結果を表示するカードコンポーネント
  - _Requirements: 10.1, 10.2, 10.3_

- [x] 7.3 (P) GPTスタイル診断を実装する
  - 利用パターンからタイプ（思索型、企画爆発型等）を診断するプロンプト設計
  - 相性スコア（%）の算出
  - 診断結果の説明文生成
  - エンタメ性のあるカードデザイン
  - _Requirements: 11.1, 11.2, 11.3_

- [x] 7.4 (P) 名言選出を実装する
  - 印象的なプロンプトを選出するプロンプト設計
  - 選出理由と文脈の説明を生成
  - 名言を引用形式で表示するカード
  - _Requirements: 12.1, 12.2, 12.3_

- [x] 8. 知性マップ機能の実装
- [x] 8.1 Gemini Embeddings取得機能を実装する
  - gemini-embedding-001モデルでEmbeddingsを取得
  - 会話ごとにサマリーを生成してからEmbeddings化
  - バッチ処理でAPI呼び出しを最適化
  - _Requirements: 8.1_

- [x] 8.2 PCA次元削減を実装する
  - DRUIDJSを使用してEmbeddings（768次元）を2次元に削減
  - 軸の意味（技術↔企画、論理↔感情など）をLLMで推定
  - _Requirements: 8.1, 8.2_

- [x] 8.3 知性マップ可視化を実装する
  - 2Dプロットを散布図として描画
  - 各点をクリックすると会話の概要をポップアップ表示
  - 軸ラベルを表示
  - _Requirements: 8.1, 8.2, 8.3_

- [x] 9. UI/UX強化
- [x] 9.1 カードスワイプ/スクロールUIを実装する
  - Spotify Wrapped風のカード形式レイアウト
  - スワイプまたはスクロールで次のカードに遷移
  - スムーズなアニメーション効果
  - _Requirements: 13.1, 13.3_

- [x] 9.2 進行状況表示コンポーネントを強化する
  - 7ステップの進捗をプログレスバーで表示
  - 現在処理中の項目名を表示
  - エラー時のリトライボタン
  - _Requirements: 14.1, 14.2, 14.3_

- [x] 9.3 (P) レスポンシブデザインを適用する
  - モバイル、タブレット、デスクトップ対応
  - タッチ操作の最適化
  - _Requirements: 13.4_

- [x] 10. エクスポート機能の実装
- [x] 10.1 PNG画像エクスポートを実装する
  - 各カードをPNG画像としてダウンロード
  - html2canvasでDOM要素をキャプチャ
  - _Requirements: 15.1_

- [x] 10.2 (P) PDFエクスポートを実装する
  - 全結果をPDFとしてダウンロード
  - html2pdf.jsで複数ページに対応
  - _Requirements: 15.2_

- [x] 10.3 (P) SNS共有用サマリー画像を実装する
  - 主要な統計情報をまとめたサマリー画像を生成
  - SNS投稿に適したアスペクト比
  - _Requirements: 15.3_

- [x] 11. 統合とテスト
- [x] 11.1 全体フローの統合テスト
  - ファイルアップロード→解析→基本統計→LLM分析→結果表示の一連のフローを確認
  - エラーケースの動作確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 5.1, 5.2, 5.3, 6.1, 6.2, 6.3, 7.1, 7.2, 7.3, 8.1, 8.2, 8.3, 9.1, 9.2, 9.3, 10.1, 10.2, 10.3, 11.1, 11.2, 11.3, 12.1, 12.2, 12.3, 14.1, 14.2, 14.3_

- [x] 11.2 エッジケースの対応
  - 空の会話データ、極端に大きなデータ、特殊文字を含むデータのハンドリング
  - ネットワークエラー、タイムアウトの適切な処理
  - _Requirements: 1.3, 1.4, 2.3, 14.3_
